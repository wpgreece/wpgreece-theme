/*
 * jquery.nevma.anchorPopup 1.0 - Anchor to popup plugin.
 * 
 * Copyright (c) 2012 Nevma.Gr
 * http://www.nevma.gr
 *
 * All right reserved!
 *
 */

jQuery.fn.anchorPopup=function(g){function p(a,b){var e=null;return function(){var i=this,d=arguments;clearTimeout(e);e=setTimeout(function(){a.apply(i,d)},b)}}function l(a){if(a.hasClass(b.imageClass))return!0;var a=a.attr("href"),c=a.lastIndexOf(".");if(0<c)for(var a=a.substring(c+1),c=0,e=b.imageTypes.length;c<e;c++)if(a==b.imageTypes[c])return!0;return!1}function m(a,c,e,i){b.debug&&console.log("Image loaded");var d={width:jQuery(window).width(),height:jQuery(window).height()},f=b.imageMaxHeightFactor; d.width*=b.imageMaxWidthFactor;d.height*=f;var f=!1,k=1,g=1;a.width>d.width&&(f=!0,k=d.width/a.width,b.debug&&console.log("Width scale: "+k));a.height>d.height&&(f=!0,g=d.height/a.height,b.debug&&console.log("Height scale: "+g));d=1;f&&(d=Math.min(k,g),b.debug&&console.log("Final scale: "+d));a='<img src = "'+a.src+'" alt = "'+c+'" title = "'+c+'" style = "display: block; width: '+Math.floor(d*a.width)+"px; height: "+Math.floor(d*a.height)+'px;"/>';j&&(a+='<p class = "popup-image-info">'+c+" (image "+ (i+1)+" of "+h.length+")</p>",0<i&&(a+='<a class = "popup-previous" href = "#'+(i-1)+'" title = "'+b.imagePreviousTitle+" ("+i+" of "+h.length+' images)">'+b.imagePreviousTitle+"</a>"),i<h.length-1&&(a+='<a class = "popup-next"href = "#'+(i+1)+'" title = "'+b.imageNextTitle+" ("+(i+2)+" of "+h.length+' images)">'+b.imageNextTitle+"</a>"));e.setContents(a,function(){jQuery(".popup-next, .popup-previous").click(function(){var a=jQuery(this).attr("href"),a=(new Number(a.substring(1))).valueOf();b.debug&& console.log("Index: "+a);n(jQuery(h.get(a)),true);return false})})}function n(a,c){b.debug&&console.log("Image");var e=a.attr("href"),i=h.index(a),d=a.attr("title");d||(d="");b.debug&&console.log("Image: "+e);var g=function(){var a=new Image;a.src=e;jQuery.browser.msie&&a.complete?m(a,d,f,i):a.onload=function(){m(a,d,f,i)}};!f||!c?(b.debug&&console.log("Create popup anew"),f=jQuery(b.loaderHTML).popup(jQuery.extend({},b.popupParameters,{maxWidthFactor:1,maxHeightFactor:1,createCallback:g}))):(b.debug&& console.log("Use existing popup"),f.appendContents(b.loaderImageGalleryHTML,g))}function q(a){b.debug&&console.log("Ajax");var c=a.attr("href");b.debug&&console.log(c);f=jQuery(b.loaderHTML).popup(jQuery.extend({},b.popupParameters,{createCallback:function(){jQuery.ajax({url:c,type:b.ajaxRequestMethodType,success:function(a){f.setContents(a)},error:function(){f.setContents(b.ajaxErrorHTML)},dataType:"html"})}}))}function o(a,c){for(var e=a.attr("class").split(" "),f=null,d=0,g=e.length;d<g;d++){var h= b.popupAttributePrefix+c+":";0==e[d].indexOf(h)&&b.debug&&(f=jQuery.trim(e[d].substring(h.length)))}return f}var b={selector:".popup-element",imageClass:"popup-image",imageTypes:["jpg","jpeg","png","gif"],imageShowNextPrevious:!0,imageShowNavigation:!0,imageNextTitle:"Next",imagePreviousTitle:"Previous",imageMaxWidthFactor:0.8,imageMaxHeightFactor:0.8,snippetClass:"popup-snippet",iframeClass:"popup-iframe",iframeDefaultWidth:600,iframeDefaultHeight:400,ajaxClass:"popup-ajax",ajaxRequestMethodType:"GET", loaderHTML:'<p class = "popup-loader"><span>Please wait...</span></p>',loaderImageGalleryHTML:'<p class = "popup-loader-image-gallery"><span>Please wait...</span></p>',ajaxErrorHTML:'<p class = "popup-error"><span>There was a problem fetching the data.</span></p>',popupAttributePrefix:"popup-",popupParameters:{},debug:!1};jQuery.extend(b,g,!0);var f,h=null,h=0<this.length?this:jQuery(b.selector);h.click(function(){var a=jQuery(this);if(l(a))return n(a),!1;var c;a.hasClass(b.snippetClass)?c=!0:(c= a.attr("href"),c=0==jQuery.trim(c).indexOf("#")?!0:!1);if(c)return b.debug&&console.log("Snippet"),a=a.attr("href"),a=jQuery(a).clone().css("visibility","visible").css("display","block"),0<a.length&&(f=jQuery(a).popup(b.popupParameters)),!1;c=a.hasClass(b.iframeClass)?!0:!1;if(c){b.debug&&console.log("Iframe");c=a.attr("href");b.debug&&console.log(c);var e=o(a,"width"),a=o(a,"height");e||(e=b.iframeDefaultWidth);a||(a=b.iframeDefaultHeight);b.debug&&(console.log("width: "+e),console.log("height: "+ a));f=jQuery('<iframe src = "'+c+'" frameborder = "0" width = "'+e+'" height = "'+a+'" marginwidth = "0" marginheight = "0" style = "display: block; border: none; width: '+e+"px; height: "+a+'px;"></iframe>').popup(b.popupParameters);return!1}c=a.hasClass(b.ajaxClass)?!0:!1;return c?(q(a),!1):!0});for(var j=!0,g=0,r=h.length;g<r;g++)if(!l(jQuery(h.get(g)))){j=!1;break}2>h.length&&(j=!1);b.debug&&console.log("All images: "+j);j&&jQuery(document).keydown(p(function(a){a=a.charCode||a.keyCode;37==a? jQuery(".popup-previous").click():39==a&&jQuery(".popup-next").click()},200))};
